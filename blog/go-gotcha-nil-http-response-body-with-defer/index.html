<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossOrigin="anonymous"/><style data-href="/app.506382439a4b4acdfe14.css">.fqxoyvp{display:var(--fqxoyvp-0);flex-direction:var(--fqxoyvp-1);justify-content:var(--fqxoyvp-2);align-content:var(--fqxoyvp-3);align-items:var(--fqxoyvp-4);width:var(--fqxoyvp-5);max-width:var(--fqxoyvp-5);padding:var(--fqxoyvp-7);flex-wrap:var(--fqxoyvp-8)}.m15xpxwi{color:#2b1d0e;-webkit-letter-spacing:2px;-moz-letter-spacing:2px;-ms-letter-spacing:2px;letter-spacing:2px;margin:0}@media screen and (max-width:40em){.m15xpxwi{font-size:20px}}@media screen and (max-width:20em){.m15xpxwi{font-size:18px}}.h10ud6k0{color:#2b1d0e;-webkit-letter-spacing:2px;-moz-letter-spacing:2px;-ms-letter-spacing:2px;letter-spacing:2px;margin:0}@media screen and (max-width:40em){.h10ud6k0{font-size:16px}}@media screen and (max-width:20em){.h10ud6k0{font-size:14px}}.h5wsek6{height:2rem;position:fixed;top:0;background:#f5f4e9;z-index:999;box-shadow:0 1px 3px rgba(0,0,0,.05);padding:16px 0;-webkit-text-decoration:none;text-decoration:none}.i4awmdj{cursor:pointer;color:#2b1d0e;font-size:1.5rem;margin-right:10px}.fpnldgf{height:4rem;box-shadow:0 -1px 3px rgba(0,0,0,.05)}.tw06ds8{text-align:center}@font-face{font-family:Lato;font-style:normal;font-weight:400;src:local("Lato Regular"),local("Lato-Regular"),url(/static/Lato-129179c4eeb1d784d3d3ad95e0b35905.woff2),url(https://fonts.gstatic.com/s/lato/v15/S6uyw4BMUTPHjx4wXiWtFCc.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:Cormorant Garamond;font-style:normal;font-weight:400;src:local("Cormorant Garamond Regular"),local("CormorantGaramond-Regular"),url(/static/CormorantGaramond-5733ac592c848166a661326d6d7dd685.woff2),url(https://fonts.gstatic.com/s/cormorantgaramond/v6/co3bmX5slCNuHLi8bLeY9MK7whWMhyjYqXtKky2F7g.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}body{margin:0;padding:0;font-family:Lato;background:#f5f4e9;color:#2b1d0e;font-size:18px}h1,h2,h3,h4,h5,h6{font-family:Cormorant Garamond}h1,h2{margin-top:4rem}h2{font-weight:600}h3{margin-top:3rem}h4{margin-top:2rem}p{line-height:1.8}a{color:#519657}a,a:link,a:visited{text-decoration:none}a:active,a:hover{color:#38693c}pre{overflow:scroll;border-radius:4px;padding:10px 20px}pre,pre code{background:#444;color:#63e463}pre code{border:none;padding:0;border-radius:0;margin:0}code{color:#3eab3e;background:rgba(99,228,99,.1);border-radius:4px;padding:2px 4px;margin:0 4px}blockquote{border-left:6px solid rgba(179,195,180,.5);padding-left:32px;margin:32px 0}li{margin-bottom:8px}.m18vmv4p{padding:6rem 0 2rem}.m1p35dyn{max-width:80%;width:800px}</style><meta name="generator" content="Gatsby 2.0.31"/><title data-react-helmet="true"></title><link as="script" rel="preload" href="/component---src-templates-article-tsx-63d862aa3d1cb4f91eae.js"/><link as="script" rel="preload" href="/1-e3748de615d3fc364f58.js"/><link as="script" rel="preload" href="/app-8f18f59409f6882e8b2f.js"/><link as="script" rel="preload" href="/webpack-runtime-0adbd497f70c7070047a.js"/><link rel="preload" href="/static/d/615/path---blog-go-gotcha-nil-http-response-body-with-defer-674-aa9-Gcn1jBN6X7qZvvtLs7dgAAS1o.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div direction="column" class="fqxoyvp" style="--fqxoyvp-0:flex;--fqxoyvp-1:column;--fqxoyvp-2:initial;--fqxoyvp-3:initial;--fqxoyvp-4:initial;--fqxoyvp-5:100%;--fqxoyvp-7:0px;--fqxoyvp-8:nowrap"><div class="h5wsek6 fqxoyvp" style="--fqxoyvp-0:flex;--fqxoyvp-1:initial;--fqxoyvp-2:initial;--fqxoyvp-3:initial;--fqxoyvp-4:initial;--fqxoyvp-5:100%;--fqxoyvp-7:0px;--fqxoyvp-8:nowrap"><div class="fqxoyvp" style="--fqxoyvp-0:flex;--fqxoyvp-1:initial;--fqxoyvp-2:initial;--fqxoyvp-3:initial;--fqxoyvp-4:center;--fqxoyvp-5:50%;--fqxoyvp-7:0px 16px;--fqxoyvp-8:nowrap"><div style="display:flex;align-items:center"><a href="/"><h2 class="m15xpxwi">Keith Alpichi</h2></a></div></div><div class="fqxoyvp" style="--fqxoyvp-0:flex;--fqxoyvp-1:initial;--fqxoyvp-2:flex-end;--fqxoyvp-3:initial;--fqxoyvp-4:initial;--fqxoyvp-5:50%;--fqxoyvp-7:0px 16px;--fqxoyvp-8:nowrap"><a href="https://www.linkedin.com/in/keithalpichi" class="i4awmdj"><i class="fab fa-linkedin"></i></a><a href="https://github.com/keithalpichi" class="i4awmdj"><i class="fab fa-github-square"></i></a><div style="display:flex;align-items:center"><a href="/about"><h3 class="h10ud6k0">About</h3></a></div></div></div><div class="m18vmv4p fqxoyvp" direction="column" style="--fqxoyvp-0:flex;--fqxoyvp-1:column;--fqxoyvp-2:initial;--fqxoyvp-3:initial;--fqxoyvp-4:center;--fqxoyvp-5:100%;--fqxoyvp-7:0px 16px;--fqxoyvp-8:nowrap"><div class="m1p35dyn fqxoyvp" style="--fqxoyvp-0:initial;--fqxoyvp-1:initial;--fqxoyvp-2:initial;--fqxoyvp-3:initial;--fqxoyvp-4:initial;--fqxoyvp-5:100%;--fqxoyvp-7:0px 16px;--fqxoyvp-8:wrap"><h1 style="line-height:1">Go Gotcha: Closing a Nil HTTP Response Body With Defer</h1><h3 style="color:#b3c3b4;margin-top:0">Wednesday, May 16th 2018</h3><div style="margin-top:64px"><p>When handling HTTP responses it is important to check the errors first before handling the responses. Even if you defer to close the <code>io.Closer</code>, in this case a response body, youâ€™ll be surprised what happens when it is nil. Avoiding this crucial step or assuming defer can deflect or handle errors will lead to a nasty panic; ultimately crashing your program. Letâ€™s see an example of this.</p>
<h2>How To Do It Incorrectly</h2>
<pre><code class="language-go">res, err := http.Get("abc.com/coffee")
defer res.Body.Close()
if err != nil {
    // handle `err`
}
// do something with `res`
</code></pre>
<p>If this function returns valid responses and nil errors you wonâ€™t experience any issues. Cool! That is, until <code>res</code> is nil. When it is youâ€™ll get a panic that looks something like this:</p>
<pre><code class="language-go">PANIC: runtime error: invalid memory address or nil pointer dereference
</code></pre>
<p>If you follow the call stack youâ€™ll be lead to the line <code>defer res.Body.Close()</code>. This error has occurred from trying to close a nil <code>io.Closer</code>. It just wonâ€™t work, itâ€™s impossible.</p>
<h2>How To Do It Correctly</h2>
<p>By simply checking for an error before doing anything with the response we can conclude what we can and cannot do next.</p>
<ul>
<li>if the error is not nil, we have an error and the response is nil. Return now or continue but avoid using the nil response</li>
<li>if the error is nil, we donâ€™t have an error and the response is not nil. We can freely use the response as we originally intended</li>
</ul>
<p>Our code could then look like this:</p>
<pre><code class="language-go">res, err := http.Get("abc.com/coffee")
if err != nil {
    return err
}
defer res.Body.Close()
// continue to use `res`
</code></pre>
<p>As you can see weâ€™ve handled the error first and returned if it was not nil. Otherwise we continued to use the response.</p>
<h2>Conclusion</h2>
<ul>
<li>always check errors immediately after functions that return them</li>
<li><code>defer</code> should only prepend non-nil functions</li>
<li><code>defer</code> does not deflect or handle errors automatically. You can, however, handle them with <code>recover</code></li>
</ul></div></div></div><div class="fpnldgf fqxoyvp" style="--fqxoyvp-0:flex;--fqxoyvp-1:initial;--fqxoyvp-2:center;--fqxoyvp-3:center;--fqxoyvp-4:initial;--fqxoyvp-5:100%;--fqxoyvp-7:0px;--fqxoyvp-8:nowrap"><div class="fqxoyvp" style="--fqxoyvp-0:initial;--fqxoyvp-1:initial;--fqxoyvp-2:initial;--fqxoyvp-3:initial;--fqxoyvp-4:initial;--fqxoyvp-5:100%;--fqxoyvp-7:0px 16px;--fqxoyvp-8:wrap"><p class="tw06ds8">Mahalo ðŸ¤™</p></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-article-tsx","jsonName":"blog-go-gotcha-nil-http-response-body-with-defer-674","path":"/blog/go-gotcha-nil-http-response-body-with-defer"};window.dataPath="615/path---blog-go-gotcha-nil-http-response-body-with-defer-674-aa9-Gcn1jBN6X7qZvvtLs7dgAAS1o";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.506382439a4b4acdfe14.css","/app-8f18f59409f6882e8b2f.js"],"component---src-templates-article-tsx":["/component---src-templates-article-tsx-63d862aa3d1cb4f91eae.js"],"component---src-templates-tags-tsx":["/component---src-templates-tags-tsx-e7819269c76effaddee6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-695abf52f70b8b59c1c3.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-3805d29f82d6b81a1512.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx.5f018c0f41cc21e590cc.css","/component---src-pages-index-tsx-4ba1aab2715530bb72db.js"],"component---src-pages-tags-tsx":["/component---src-pages-tags-tsx-1dab9c7cbc6fe2ad05f4.js"]};/*]]>*/</script><script src="/webpack-runtime-0adbd497f70c7070047a.js" async=""></script><script src="/app-8f18f59409f6882e8b2f.js" async=""></script><script src="/1-e3748de615d3fc364f58.js" async=""></script><script src="/component---src-templates-article-tsx-63d862aa3d1cb4f91eae.js" async=""></script></body></html>